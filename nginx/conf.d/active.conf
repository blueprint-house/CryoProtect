# Default active environment is blue
# This file will be updated by the deployment script during cutover
# ACTIVE_COLOR: blue
# ACTIVE_VERSION: latest
# DEPLOYMENT_TIMESTAMP: 2025-04-25T13:46:00

server {
    listen 80 default_server;
    server_name localhost;
    
    # Proxy timeouts
    proxy_connect_timeout 5s;
    proxy_send_timeout 10s;
    proxy_read_timeout 10s;
    
    # Proxy cache settings
    proxy_cache_bypass $http_upgrade;
    proxy_http_version 1.1;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection 'upgrade';
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_set_header X-Forwarded-Host $host;
    proxy_set_header X-Forwarded-Port $server_port;
    proxy_set_header X-Environment blue;

    # Main application
    location / {
        proxy_pass http://blue;
        
        # Error handling
        proxy_intercept_errors on;
        error_page 502 503 504 /maintenance.html;
    }

    # Health check endpoints
    location = /health {
        proxy_pass http://blue/health;
        access_log off;
        
        # Fail if upstream is down
        proxy_next_upstream off;
        proxy_intercept_errors on;
        error_page 502 503 504 = @health_fail;
    }
    
    # Liveness probe
    location = /health/liveness {
        proxy_pass http://blue/health/liveness;
        access_log off;
        
        # Fail if upstream is down
        proxy_next_upstream off;
        proxy_intercept_errors on;
        error_page 502 503 504 = @health_fail;
    }
    
    # Readiness probe
    location = /health/readiness {
        proxy_pass http://blue/health/readiness;
        access_log off;
        
        # Fail if upstream is down
        proxy_next_upstream off;
        proxy_intercept_errors on;
        error_page 502 503 504 = @health_fail;
    }
    
    # Startup probe
    location = /health/startup {
        proxy_pass http://blue/health/startup;
        access_log off;
        
        # Fail if upstream is down
        proxy_next_upstream off;
        proxy_intercept_errors on;
        error_page 502 503 504 = @health_fail;
    }
    
    location @health_fail {
        add_header Content-Type application/json;
        return 503 '{"status":"error","error":"Service Unavailable","timestamp":"$time_iso8601"}';
    }
    
    # Static maintenance page
    location = /maintenance.html {
        root /usr/share/nginx/html;
        internal;
    }
    
    # Metrics endpoint (protected)
    location /metrics {
        proxy_pass http://blue/metrics;
        # Restrict access to internal network
        allow 127.0.0.1;
        allow 172.16.0.0/12;
        deny all;
    }
}