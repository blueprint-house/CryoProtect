{% extends 'base.html' %}

{% set active_page = 'predictions' %}
{% set breadcrumbs = [
  {'title': 'Home', 'url': '/'},
  {'title': 'Mixtures', 'url': '/mixtures'},
  {'title': 'Mixture Details', 'url': '/mixtures/' ~ mixture_id if mixture_id is defined else '#'},
  {'title': 'Predictions', 'url': '#'}
] %}

{% block title %}Predictions - CryoProtect Analyzer{% endblock %}

{% block content %}
    <!-- Mixture Information -->
    <div class="card mb-4">
      <div class="card-header">
        <h3 class="h5 mb-0">Mixture Information</h3>
      </div>
      <div class="card-body">
        <div class="row">
          <div class="col-md-6">
            <h4 id="mixture-name-display">Loading mixture...</h4>
            <p id="mixture-description-display">-</p>
          </div>
          <div class="col-md-6">
            <h5>Components</h5>
            <ul class="list-group" id="mixture-components-display">
              <!-- Components will be loaded here dynamically -->
            </ul>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Predictions List View -->
    <div id="predictions-list-view">
      <div class="d-flex justify-content-between align-items-center mb-4">
        <h2>Predictions</h2>
        <a href="#" class="btn btn-primary requires-auth disabled" id="add-prediction-btn">
          <i class="bi bi-plus-circle" aria-hidden="true"></i> Add Prediction
        </a>
      </div>
      
      <div id="predictions-container">
        <!-- Predictions will be loaded here dynamically -->
        <div class="text-center py-5" aria-live="polite">
          <div class="spinner-border" role="status">
            <span class="visually-hidden">Loading...</span>
          </div>
          <p class="mt-2">Loading predictions...</p>
        </div>
      </div>
    </div>
    
    <!-- Add Prediction View -->
    <div id="add-prediction-view" style="display: none;">
      {% set workflow_steps = [
        {'title': 'Select Property'},
        {'title': 'Enter Value'},
        {'title': 'Set Confidence'},
        {'title': 'Choose Method'}
      ] %}
      {% set current_step = 0 %}
      {% include 'shared/progress_indicator.html' %}
      
      <div class="d-flex justify-content-between align-items-center mb-4">
        <h2>Add Prediction</h2>
        <button type="button" class="btn btn-outline-secondary" id="back-to-predictions-btn">
          <i class="bi bi-arrow-left" aria-hidden="true"></i> Back to Predictions
        </button>
      </div>
      
      <div class="card">
        <div class="card-header">
          <h3 class="h5 mb-0">Prediction Details</h3>
        </div>
        <div class="card-body">
          <form id="prediction-form">
            <div class="mb-3">
              <label for="prediction-property" class="form-label">Property</label>
              <select class="form-select" id="prediction-property" required aria-describedby="property-help">
                <option value="">Select a property</option>
                <!-- Property options will be loaded dynamically -->
              </select>
              <div id="property-help" class="form-text visually-hidden">Select the property you want to predict</div>
            </div>
            <div class="mb-3">
              <label for="prediction-value" class="form-label">Value</label>
              <input type="text" class="form-control" id="prediction-value" required aria-describedby="value-help">
              <div id="value-help" class="form-text">Enter a numeric value, text, or boolean (true/false) depending on the property type.</div>
            </div>
            <div class="mb-3">
              <label for="prediction-confidence" class="form-label">Confidence (0-1)</label>
              <input type="number" class="form-control" id="prediction-confidence" min="0" max="1" step="0.01" value="0.8" required aria-describedby="confidence-help">
              <div id="confidence-help" class="form-text">Enter a value between 0 (low confidence) and 1 (high confidence).</div>
            </div>
            <div class="mb-3">
              <label for="prediction-method" class="form-label">Calculation Method</label>
              <select class="form-select" id="prediction-method" required aria-describedby="method-help">
                <option value="">Select a method</option>
                <option value="CryoProtect Scoring">CryoProtect Scoring</option>
                <option value="Molecular Dynamics">Molecular Dynamics</option>
                <option value="QSAR Model">QSAR Model</option>
                <option value="Manual Estimation">Manual Estimation</option>
              </select>
              <div id="method-help" class="form-text visually-hidden">Select the method used to calculate this prediction</div>
            </div>
            <div class="d-grid gap-2">
              <button type="submit" class="btn btn-primary">Add Prediction</button>
            </div>
          </form>
        </div>
      </div>
    </div>
{% endblock %}

{% block extra_css %}
<!-- No extra CSS for predictions page -->
{% endblock %}

{% block extra_js %}
<script>
    // Initialize page based on URL
    document.addEventListener('DOMContentLoaded', function() {
      // Add event listener for the "Add Prediction" button
      document.getElementById('add-prediction-btn').addEventListener('click', function(event) {
        event.preventDefault();
        document.getElementById('predictions-list-view').style.display = 'none';
        document.getElementById('add-prediction-view').style.display = 'block';
        // Set focus to the first form field for keyboard accessibility
        document.getElementById('prediction-property').focus();
      });
      
      // Add event listener for the "Back to Predictions" button
      document.getElementById('back-to-predictions-btn').addEventListener('click', function(event) {
        event.preventDefault();
        document.getElementById('predictions-list-view').style.display = 'block';
        document.getElementById('add-prediction-view').style.display = 'none';
        // Return focus to the add prediction button
        document.getElementById('add-prediction-btn').focus();
      });
    });
  // Add event listeners for form fields to update progress indicator
  document.getElementById('prediction-property').addEventListener('change', function() {
    if (this.value) {
      document.querySelectorAll('.progress-step')[0].classList.add('completed');
      document.querySelectorAll('.progress-step')[1].classList.add('active');
      document.querySelectorAll('.progress-step')[0].classList.remove('active');
    }
  });
  
  document.getElementById('prediction-value').addEventListener('input', function() {
    if (this.value) {
      document.querySelectorAll('.progress-step')[1].classList.add('completed');
      document.querySelectorAll('.progress-step')[2].classList.add('active');
      document.querySelectorAll('.progress-step')[1].classList.remove('active');
    }
  });
  
  document.getElementById('prediction-confidence').addEventListener('input', function() {
    if (this.value) {
      document.querySelectorAll('.progress-step')[2].classList.add('completed');
      document.querySelectorAll('.progress-step')[3].classList.add('active');
      document.querySelectorAll('.progress-step')[2].classList.remove('active');
    }
  });
  
  document.getElementById('prediction-method').addEventListener('change', function() {
    if (this.value) {
      document.querySelectorAll('.progress-step')[3].classList.add('completed');
      document.querySelectorAll('.progress-step')[3].classList.remove('active');
    }
  });
</script>
{% endblock %}