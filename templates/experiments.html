{% extends 'base.html' %}

{% set active_page = 'experiments' %}
{% set breadcrumbs = [
  {'title': 'Home', 'url': '/'},
  {'title': 'Mixtures', 'url': '/mixtures'},
  {'title': 'Mixture Details', 'url': '/mixtures/' ~ mixture_id if mixture_id is defined else '#'},
  {'title': 'Experiments', 'url': '#'}
] %}

{% block title %}Experiments - CryoProtect Analyzer{% endblock %}

{% block content %}
    <!-- Mixture Information -->
    <div class="card mb-4">
      <div class="card-header">
        <h3 class="h5 mb-0">Mixture Information</h3>
      </div>
      <div class="card-body">
        <div class="row">
          <div class="col-md-6">
            <h4 id="mixture-name-display">Loading mixture...</h4>
            <p id="mixture-description-display">-</p>
          </div>
          <div class="col-md-6">
            <h5>Components</h5>
            <ul class="list-group" id="mixture-components-display">
              <!-- Components will be loaded here dynamically -->
            </ul>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Experiments List View -->
    <div id="experiments-list-view">
      <div class="d-flex justify-content-between align-items-center mb-4">
        <h2>Experiments</h2>
        <a href="#" class="btn btn-primary requires-auth disabled" id="add-experiment-btn">
          <i class="bi bi-plus-circle" aria-hidden="true"></i> Record Experiment
        </a>
      </div>
      
      <div id="experiments-container">
        <!-- Experiments will be loaded here dynamically -->
        <div class="text-center py-5" aria-live="polite">
          <div class="spinner-border" role="status">
            <span class="visually-hidden">Loading...</span>
          </div>
          <p class="mt-2">Loading experiments...</p>
        </div>
      </div>
    </div>
    
    <!-- Add Experiment View -->
    <div id="add-experiment-view" style="display: none;">
      {% set workflow_steps = [
        {'title': 'Select Property'},
        {'title': 'Enter Value'},
        {'title': 'Describe Conditions'},
        {'title': 'Set Date'}
      ] %}
      {% set current_step = 0 %}
      {% include 'shared/progress_indicator.html' %}
      
      <div class="d-flex justify-content-between align-items-center mb-4">
        <h2>Record Experiment</h2>
        <button type="button" class="btn btn-outline-secondary" id="back-to-experiments-btn">
          <i class="bi bi-arrow-left" aria-hidden="true"></i> Back to Experiments
        </button>
      </div>
      
      <div class="card">
        <div class="card-header">
          <h3 class="h5 mb-0">Experiment Details</h3>
        </div>
        <div class="card-body">
          <form id="experiment-form">
            <div class="mb-3">
              <label for="experiment-property" class="form-label">Property</label>
              <select class="form-select" id="experiment-property" required aria-describedby="property-help">
                <option value="">Select a property</option>
                <!-- Property options will be loaded dynamically -->
              </select>
              <div id="property-help" class="form-text visually-hidden">Select the property you measured in this experiment</div>
            </div>
            <div class="mb-3">
              <label for="experiment-value" class="form-label">Value</label>
              <input type="text" class="form-control" id="experiment-value" required aria-describedby="value-help">
              <div id="value-help" class="form-text">Enter a numeric value, text, or boolean (true/false) depending on the property type.</div>
            </div>
            <div class="mb-3">
              <label for="experiment-conditions" class="form-label">Experimental Conditions</label>
              <textarea class="form-control" id="experiment-conditions" rows="3" aria-describedby="conditions-help"></textarea>
              <div id="conditions-help" class="form-text">Describe the conditions under which the experiment was performed (e.g., temperature, pressure, equipment used).</div>
            </div>
            <div class="mb-3">
              <label for="experiment-date" class="form-label">Date Performed</label>
              <input type="date" class="form-control" id="experiment-date" required aria-describedby="date-help">
              <div id="date-help" class="form-text visually-hidden">The date when the experiment was performed</div>
            </div>
            <div class="d-grid gap-2">
              <button type="submit" class="btn btn-primary">Record Experiment</button>
            </div>
          </form>
        </div>
      </div>
    </div>
{% endblock %}

{% block extra_css %}
<!-- No extra CSS for experiments page -->
{% endblock %}

{% block extra_js %}
<script>
    // Initialize page based on URL
    document.addEventListener('DOMContentLoaded', function() {
      // Add event listener for the "Record Experiment" button
      document.getElementById('add-experiment-btn').addEventListener('click', function(event) {
        event.preventDefault();
        document.getElementById('experiments-list-view').style.display = 'none';
        document.getElementById('add-experiment-view').style.display = 'block';
        // Set focus to the first form field for keyboard accessibility
        document.getElementById('experiment-property').focus();
      });
      
      // Add event listener for the "Back to Experiments" button
      document.getElementById('back-to-experiments-btn').addEventListener('click', function(event) {
        event.preventDefault();
        document.getElementById('experiments-list-view').style.display = 'block';
        document.getElementById('add-experiment-view').style.display = 'none';
        // Return focus to the add experiment button
        document.getElementById('add-experiment-btn').focus();
      });
      
      // Set default date to today
      const today = new Date().toISOString().split('T')[0];
      document.getElementById('experiment-date').value = today;
    });
  // Add event listeners for form fields to update progress indicator
  document.getElementById('experiment-property').addEventListener('change', function() {
    if (this.value) {
      document.querySelectorAll('.progress-step')[0].classList.add('completed');
      document.querySelectorAll('.progress-step')[1].classList.add('active');
      document.querySelectorAll('.progress-step')[0].classList.remove('active');
    }
  });
  
  document.getElementById('experiment-value').addEventListener('input', function() {
    if (this.value) {
      document.querySelectorAll('.progress-step')[1].classList.add('completed');
      document.querySelectorAll('.progress-step')[2].classList.add('active');
      document.querySelectorAll('.progress-step')[1].classList.remove('active');
    }
  });
  
  document.getElementById('experiment-conditions').addEventListener('input', function() {
    if (this.value) {
      document.querySelectorAll('.progress-step')[2].classList.add('completed');
      document.querySelectorAll('.progress-step')[3].classList.add('active');
      document.querySelectorAll('.progress-step')[2].classList.remove('active');
    }
  });
  
  document.getElementById('experiment-date').addEventListener('change', function() {
    if (this.value) {
      document.querySelectorAll('.progress-step')[3].classList.add('completed');
      document.querySelectorAll('.progress-step')[3].classList.remove('active');
    }
  });
</script>
{% endblock %}
<script src="{{ url_for('static', filename='js/lab-verification.js') }}"></script>