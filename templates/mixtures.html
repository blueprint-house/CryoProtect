{% extends 'base.html' %}

{% set active_page = 'mixtures' %}
{% set breadcrumbs = [
  {'title': 'Home', 'url': '/'},
  {'title': 'Mixtures', 'url': '/mixtures'}
] %}

{% block title %}Mixtures - CryoProtect Analyzer{% endblock %}

{% block extra_css %}
<link href="{{ url_for('static', filename='css/export-sharing.css') }}" rel="stylesheet">
<link rel="stylesheet" href="https://3Dmol.org/build/3Dmol-min.css">
<style>
  .molecular-viewer {
    border: 1px solid #dee2e6;
    border-radius: 0.25rem;
    overflow: hidden;
  }
  
  .molecular-viewer canvas {
    outline: none;
  }
  
  /* Accessibility improvements */
  .sr-only {
    position: absolute;
    width: 1px;
    height: 1px;
    padding: 0;
    margin: -1px;
    overflow: hidden;
    clip: rect(0, 0, 0, 0);
    white-space: nowrap;
    border-width: 0;
  }
  
  /* Focus indicators for keyboard navigation */
  .btn:focus {
    box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.5);
    z-index: 1;
  }
</style>
{% endblock %}

{% block content %}
    <!-- Mixtures List View -->
    <div id="mixtures-list-view">
      <div class="d-flex justify-content-between align-items-center mb-4">
        <h1>Mixtures</h1>
        {% if current_user.is_authenticated %}
        <a href="/mixtures/new" class="btn btn-primary">
          <i class="bi bi-plus-circle"></i> Create Mixture
        </a>
        {% else %}
        <span class="btn btn-primary disabled" title="Login required to create mixtures">
          <i class="bi bi-plus-circle"></i> Create Mixture
        </span>
        <span class="ms-2 text-danger align-self-center">Login to create mixtures</span>
        {% endif %}
      </div>
      
      <!-- Search and Filter -->
      <div class="card mb-4">
        <div class="card-body">
          <div class="row">
            <div class="col-12 col-md-8 mb-3 mb-md-0">
              <div class="input-group">
                <label for="mixture-search" class="visually-hidden">Search mixtures</label>
                <input type="text" class="form-control" id="mixture-search" placeholder="Search mixtures..." aria-label="Search mixtures">
                <button class="btn btn-outline-secondary" type="button" id="search-button" aria-label="Search">
                  <i class="bi bi-search" aria-hidden="true"></i> <span class="visually-hidden">Search</span>
                </button>
              </div>
            </div>
            <div class="col-12 col-md-4">
              <label for="mixture-filter" class="visually-hidden">Filter mixtures</label>
              <select class="form-select" id="mixture-filter" aria-label="Filter mixtures">
                <option value="all">All Mixtures</option>
                <option value="recent">Recently Created</option>
                <option value="my-mixtures">My Mixtures</option>
              </select>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Mixtures Grid -->
      <div class="row" id="mixtures-container">
        <!-- Mixtures will be loaded here dynamically -->
        <div class="col-12 text-center py-5" aria-live="polite">
          <div class="spinner-border" role="status">
            <span class="visually-hidden">Loading...</span>
          </div>
          <p class="mt-2">Loading mixtures...</p>
        </div>
      </div>
    </div>
    
    <!-- Mixture Detail View -->
    <div id="mixture-detail-view" style="display: none;">
      <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 id="mixture-name">Mixture Name</h1>
        <a href="/mixtures" class="btn btn-outline-secondary">
          <i class="bi bi-arrow-left"></i> Back to Mixtures
        </a>
      </div>
      
      <div class="row">
        <div class="col-12 col-lg-6 mb-4">
          <div class="card mb-4">
            <div class="card-header">
              <h3 class="h5 mb-0">Basic Information</h3>
            </div>
            <div class="card-body">
              <p><strong>Description:</strong> <span id="mixture-description">-</span></p>
              <p><strong>Created:</strong> <span id="mixture-created-at">-</span></p>
            </div>
          </div>
          
          <div class="card mb-4">
            <div class="card-header">
              <h3 class="h5 mb-0">Components</h3>
            </div>
            <div class="card-body">
              <ul class="list-group" id="mixture-components">
                <!-- Components will be loaded here dynamically -->
              </ul>
            </div>
          </div>
          
          <div class="card mb-4">
            <div class="card-header d-flex justify-content-between align-items-center">
              <h3 class="h5 mb-0">Component Visualization</h3>
              <div class="dropdown">
                <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" id="componentSelector" data-bs-toggle="dropdown" aria-expanded="false">
                  Select Component
                </button>
                <ul class="dropdown-menu" id="component-dropdown" aria-labelledby="componentSelector">
                  <!-- Components will be added here dynamically -->
                </ul>
              </div>
            </div>
            <div class="card-body">
              <div id="mixture-component-viewer" class="molecular-viewer" style="height: 300px; width: 100%; position: relative;">
                <div class="text-center py-5">
                  <p class="text-muted">Select a component to view 3D structure</p>
                </div>
              </div>
              <div class="mt-3">
                <div class="d-flex justify-content-center" role="group" aria-label="Visualization style">
                  <button type="button" class="btn btn-outline-primary btn-sm me-1" id="mixture-style-stick">
                    <i class="bi bi-diagram-3"></i> Stick
                  </button>
                  <button type="button" class="btn btn-outline-primary btn-sm me-1" id="mixture-style-sphere">
                    <i class="bi bi-circle"></i> Sphere
                  </button>
                  <button type="button" class="btn btn-outline-primary btn-sm me-1" id="mixture-style-line">
                    <i class="bi bi-slash-lg"></i> Line
                  </button>
                  <button type="button" class="btn btn-outline-secondary btn-sm me-1" id="mixture-toggle-surface">
                    <i class="bi bi-egg"></i> Surface
                  </button>
                  <button type="button" class="btn btn-outline-secondary btn-sm me-1" id="mixture-toggle-spin">
                    <i class="bi bi-arrow-repeat"></i> Spin
                  </button>
                  <button type="button" class="btn btn-outline-secondary btn-sm" id="mixture-reset-view">
                    <i class="bi bi-arrow-counterclockwise"></i> Reset
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>
        
        <div class="col-12 col-lg-6">
          <div class="card mb-4">
            <div class="card-header">
              <h3 class="h5 mb-0">Composition</h3>
            </div>
            <div class="card-body">
              <div class="chart-container">
                <canvas id="mixture-composition-chart" aria-label="Mixture composition chart" role="img"></canvas>
                <div id="mixture-composition-description" class="visually-hidden">
                  Pie chart showing the composition of the mixture by percentage of each component.
                </div>
              </div>
              <div class="table-responsive mt-3">
                <!-- Composition data table will be dynamically inserted here -->
              </div>
            </div>
          </div>
          
          <div class="card">
            <div class="card-header">
              <h3 class="h5 mb-0">Actions</h3>
            </div>
            <div class="card-body">
              <div class="d-grid gap-2">
                {% if current_user.is_authenticated %}
                <a href="#" class="btn btn-primary" id="add-prediction-btn">
                  <i class="bi bi-graph-up"></i> Add Prediction
                </a>
                <a href="#" class="btn btn-success" id="record-experiment-btn">
                  <i class="bi bi-clipboard-data"></i> Record Experiment
                </a>
                <a href="#" class="btn btn-info" id="compare-results-btn">
                  <i class="bi bi-bar-chart"></i> Compare Results
                </a>
                {% else %}
                <span class="btn btn-primary disabled" title="Login required to add predictions">
                  <i class="bi bi-graph-up"></i> Add Prediction
                </span>
                <span class="btn btn-success disabled mt-2" title="Login required to record experiments">
                  <i class="bi bi-clipboard-data"></i> Record Experiment
                </span>
                <span class="btn btn-info disabled mt-2" title="Login required to compare results">
                  <i class="bi bi-bar-chart"></i> Compare Results
                </span>
                <div class="mt-2 text-danger">Login to access these actions</div>
                {% endif %}
                <button class="btn btn-outline-primary" id="export-btn" data-bs-toggle="collapse" data-bs-target="#exportOptions" aria-expanded="false" aria-controls="exportOptions">
                  <i class="bi bi-download" aria-hidden="true"></i> Export Data
                </button>
                <button class="btn btn-outline-secondary" id="share-btn" data-bs-toggle="collapse" data-bs-target="#shareOptions" aria-expanded="false" aria-controls="shareOptions">
                  <i class="bi bi-share" aria-hidden="true"></i> Share Results
                </button>
              </div>
              
              <!-- Export Options -->
              <div class="collapse mt-3" id="exportOptions">
                <div class="card card-body">
                  <h5>Export Options</h5>
                  <div class="mb-3">
                    <label for="export-format" class="form-label">Format:</label>
                    <select class="form-select" id="export-format">
                      <option value="csv">CSV</option>
                      <option value="json">JSON</option>
                      <option value="excel">Excel</option>
                      <option value="pdf">PDF</option>
                    </select>
                  </div>
                  <div class="form-check mb-3">
                    <input class="form-check-input" type="checkbox" id="include-related" checked>
                    <label class="form-check-label" for="include-related">
                      Include related data (predictions, experiments)
                    </label>
                  </div>
                  <button class="btn btn-primary export-data-btn" data-type="mixtures" data-id="">
                    <i class="bi bi-download"></i> Export
                  </button>
                </div>
              </div>
              
              <!-- Share Options -->
              <div class="collapse mt-3" id="shareOptions">
                <div class="card card-body">
                  <h5>Share Options</h5>
                  <div class="mb-3">
                    <label for="share-type" class="form-label">Share Method:</label>
                    <select class="form-select" id="share-type">
                      <option value="link">Link</option>
                      <option value="email">Email</option>
                      <option value="embed">Embed</option>
                    </select>
                  </div>
                  
                  <!-- Email options (initially hidden) -->
                  <div class="mb-3 share-email-options" style="display: none;">
                    <label for="share-recipients" class="form-label">Recipients (comma-separated):</label>
                    <input type="text" class="form-control" id="share-recipients" placeholder="email1@example.com, email2@example.com">
                    
                    <label for="share-message" class="form-label mt-2">Message (optional):</label>
                    <textarea class="form-control" id="share-message" rows="3" placeholder="Enter a message to include with the shared item"></textarea>
                  </div>
                  
                  <div class="form-check mb-3">
                    <input class="form-check-input" type="checkbox" id="password-protected">
                    <label class="form-check-label" for="password-protected">
                      Password Protected
                    </label>
                  </div>
                  
                  <!-- Password field (initially hidden) -->
                  <div class="mb-3 password-field" style="display: none;">
                    <label for="share-password" class="form-label">Password:</label>
                    <input type="password" class="form-control" id="share-password">
                  </div>
                  
                  <div class="mb-3">
                    <label for="share-expiration" class="form-label">Expiration:</label>
                    <select class="form-select" id="share-expiration">
                      <option value="3600">1 hour</option>
                      <option value="86400" selected>1 day</option>
                      <option value="604800">1 week</option>
                      <option value="2592000">30 days</option>
                      <option value="0">Never</option>
                    </select>
                  </div>
                  
                  <button class="btn btn-primary share-result-btn" data-type="mixtures" data-id="">
                    <i class="bi bi-share"></i> Share
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Tabs for Predictions and Experiments -->
      <div class="mt-5">
        <ul class="nav nav-tabs" id="mixtureDetailTabs" role="tablist">
          <li class="nav-item" role="presentation">
            <button class="nav-link active" id="predictions-tab" data-bs-toggle="tab" data-bs-target="#predictions" type="button" role="tab" aria-controls="predictions" aria-selected="true">Predictions</button>
          </li>
          <li class="nav-item" role="presentation">
            <button class="nav-link" id="experiments-tab" data-bs-toggle="tab" data-bs-target="#experiments" type="button" role="tab" aria-controls="experiments" aria-selected="false">Experiments</button>
          </li>
          <li class="nav-item" role="presentation">
            <button class="nav-link" id="analysis-tab" data-bs-toggle="tab" data-bs-target="#analysis" type="button" role="tab" aria-controls="analysis" aria-selected="false">Analysis</button>
          </li>
        </ul>
        <div class="tab-content p-3 border border-top-0 rounded-bottom" id="mixtureDetailTabsContent">
          <div class="tab-pane fade show active" id="predictions" role="tabpanel" aria-labelledby="predictions-tab">
            <div class="table-responsive">
              <div id="predictions-container" aria-live="polite">
                <!-- Predictions will be loaded here dynamically -->
                <div class="text-center py-3">
                  <div class="spinner-border" role="status">
                    <span class="visually-hidden">Loading...</span>
                  </div>
                  <p class="mt-2">Loading predictions...</p>
                </div>
              </div>
            </div>
          </div>
          <div class="tab-pane fade" id="experiments" role="tabpanel" aria-labelledby="experiments-tab">
            <div class="table-responsive">
              <div id="experiments-container" aria-live="polite">
                <!-- Experiments will be loaded here dynamically -->
                <div class="text-center py-3">
                  <div class="spinner-border" role="status">
                    <span class="visually-hidden">Loading...</span>
                  </div>
                  <p class="mt-2">Loading experiments...</p>
                </div>
              </div>
            </div>
          </div>
          <div class="tab-pane fade" id="analysis" role="tabpanel" aria-labelledby="analysis-tab">
            <div class="row">
              <div class="col-md-12 mb-4">
                <div class="d-flex justify-content-between align-items-center">
                  <h4>Mixture Analysis</h4>
                  <button class="btn btn-primary btn-sm" id="analyze-mixture-btn">
                    <i class="bi bi-graph-up"></i> Analyze Mixture
                  </button>
                </div>
                <div id="mixture-analysis-container" class="mt-3">
                  <!-- Analysis results will be loaded here dynamically -->
                  <div class="text-center py-3 d-none" id="analysis-loading">
                    <div class="spinner-border" role="status">
                      <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mt-2">Analyzing mixture...</p>
                  </div>
                  <div class="table-responsive">
                    <div id="analysis-results"></div>
                  </div>
                </div>
              </div>
              
              <div class="col-12 col-lg-6 mb-4">
                <div class="card">
                  <div class="card-header d-flex flex-column flex-sm-row justify-content-between align-items-start align-items-sm-center">
                    <h5 class="mb-2 mb-sm-0">Component Compatibility</h5>
                    <button class="btn btn-outline-primary btn-sm" id="analyze-compatibility-btn">
                      <i class="bi bi-check-circle"></i> Check Compatibility
                    </button>
                  </div>
                  <div class="card-body">
                    <div id="compatibility-container">
                      <!-- Compatibility analysis will be loaded here -->
                      <p class="text-muted">Click the button to analyze component compatibility.</p>
                      <div class="table-responsive mt-3" id="compatibility-table-container"></div>
                    </div>
                  </div>
                </div>
              </div>
              
              <div class="col-12 col-lg-6 mb-4">
                <div class="card">
                  <div class="card-header d-flex flex-column flex-sm-row justify-content-between align-items-start align-items-sm-center">
                    <h5 class="mb-2 mb-sm-0">Synergy Analysis</h5>
                    <button class="btn btn-outline-primary btn-sm" id="analyze-synergy-btn">
                      <i class="bi bi-arrow-up-right-circle"></i> Check Synergy
                    </button>
                  </div>
                  <div class="card-body">
                    <div id="synergy-container">
                      <!-- Synergy analysis will be loaded here -->
                      <p class="text-muted">Click the button to analyze component synergy.</p>
                      <div class="table-responsive mt-3" id="synergy-table-container"></div>
                    </div>
                  </div>
                </div>
              </div>
              
              <div class="col-md-12 mb-4">
                <div class="card">
                  <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">Composition Optimization</h5>
                    <button class="btn btn-outline-primary btn-sm" id="optimize-composition-btn">
                      <i class="bi bi-sliders"></i> Optimize Composition
                    </button>
                  </div>
                  <div class="card-body">
                    <div id="optimization-container">
                      <!-- Optimization results will be loaded here -->
                      <p class="text-muted">Click the button to optimize the mixture composition.</p>
                      <div class="table-responsive mt-3" id="optimization-table-container"></div>
                    </div>
                  </div>
                </div>
              </div>
              
              <div class="col-md-12">
                <div class="card">
                  <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">Component Recommendations</h5>
                    <button class="btn btn-outline-primary btn-sm" id="recommend-components-btn">
                      <i class="bi bi-lightbulb"></i> Get Recommendations
                    </button>
                  </div>
                  <div class="card-body">
                    <div id="recommendations-container">
                      <!-- Component recommendations will be loaded here -->
                      <p class="text-muted">Click the button to get component recommendations.</p>
                      <div class="table-responsive mt-3" id="recommendations-table-container"></div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Create Mixture View -->
    <div id="create-mixture-view" style="display: none;">
      {% set workflow_steps = [
        {'title': 'Basic Info'},
        {'title': 'Add Components'},
        {'title': 'Review & Create'}
      ] %}
      {% set current_step = 0 %}
      {% include 'shared/progress_indicator.html' %}
      
      <div class="d-flex justify-content-between align-items-center mb-4">
        <h1>Create New Mixture</h1>
        <a href="/mixtures" class="btn btn-outline-secondary">
          <i class="bi bi-arrow-left"></i> Back to Mixtures
        </a>
      </div>
      
      <div class="card">
        <div class="card-header">
          Mixture Details
        </div>
        <div class="card-body">
          <form id="mixture-form">
            <div class="mb-3">
              <label for="mixture-name" class="form-label">Mixture Name</label>
              <input type="text" class="form-control" id="mixture-name" required>
            </div>
            <div class="mb-3">
              <label for="mixture-description" class="form-label">Description</label>
              <textarea class="form-control" id="mixture-description" rows="3"></textarea>
            </div>
            
            <h5 class="mt-4 mb-3">Components</h5>
            
            <!-- Hidden select for molecules (used as a template) -->
            <select class="d-none" id="molecule-select" aria-label="Select a molecule">
              <!-- Will be populated with molecules -->
              <option value="">Select a molecule</option>
            </select>
            
            <div id="components-container">
              <!-- Component rows will be added here -->
            </div>
            
            <div class="mt-3">
              <button type="button" class="btn btn-outline-primary" id="add-component-button">
                <i class="bi bi-plus-circle"></i> Add Component
              </button>
            </div>
            
            <div class="d-grid gap-2 mt-4">
              <button type="submit" class="btn btn-primary">Create Mixture</button>
            </div>
          </form>
        </div>
      </div>
    </div>
{% endblock %}

{% block extra_js %}
<!-- Additional JS for mixtures page -->
<script src="https://3Dmol.org/build/3Dmol-min.js"></script>
<script src="{{ url_for('static', filename='js/molecular-viewer.js') }}"></script>
<script src="{{ url_for('static', filename='js/mixture-analysis.js') }}"></script>
<script src="{{ url_for('static', filename='js/export-sharing.js') }}"></script>

<script>
    // Initialize page based on URL
    document.addEventListener('DOMContentLoaded', function() {
      const path = window.location.pathname;
      
      // Show the appropriate view based on the URL
      if (path.endsWith('/new')) {
        document.getElementById('mixtures-list-view').style.display = 'none';
        document.getElementById('mixture-detail-view').style.display = 'none';
        document.getElementById('create-mixture-view').style.display = 'block';
      } else if (path.match(/\/mixtures\/[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i)) {
        document.getElementById('mixtures-list-view').style.display = 'none';
        document.getElementById('mixture-detail-view').style.display = 'block';
        document.getElementById('create-mixture-view').style.display = 'none';
        
        // Set up mixture analysis event handlers
        setupMixtureAnalysis();
        
        // Set up export and sharing functionality
        setupExportAndSharing();
      } else {
        document.getElementById('mixtures-list-view').style.display = 'block';
        document.getElementById('mixture-detail-view').style.display = 'none';
        document.getElementById('create-mixture-view').style.display = 'none';
      }
      
      // Initialize molecular viewer for mixture components
      if (path.match(/\/mixtures\/[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i)) {
        const mixtureId = path.split('/').pop();
        
        // Fetch mixture details
        fetch(`/api/v1/mixtures/${mixtureId}`)
          .then(response => response.json())
          .then(mixture => {
            if (mixture && mixture.components && mixture.components.length > 0) {
              // Initialize the 3D viewer
              MolecularViewer.initViewer('mixture-component-viewer', {
                backgroundColor: 'white',
                height: 300
              });
              
              // Populate component dropdown
              const dropdown = document.getElementById('component-dropdown');
              dropdown.innerHTML = '';
              
              mixture.components.forEach((component, index) => {
                const item = document.createElement('li');
                const button = document.createElement('button');
                button.className = 'dropdown-item';
                button.textContent = component.name || `Component ${index + 1}`;
                button.dataset.smiles = component.smiles;
                button.dataset.index = index;
                button.addEventListener('click', function() {
                  // Update dropdown button text
                  document.getElementById('componentSelector').textContent = this.textContent;
                  
                  // Load the molecule from SMILES
                  if (this.dataset.smiles) {
                    MolecularViewer.loadMoleculeFromSmiles('mixture-component-viewer', this.dataset.smiles, {
                      style: 'stick',
                      colorScheme: 'cyanCarbon',
                      showLabels: false,
                      showHydrogens: true
                    });
                  }
                });
                
                item.appendChild(button);
                dropdown.appendChild(item);
              });
              
              // Set up viewer controls
              setupMixtureComponentViewerControls('mixture-component-viewer');
              
              // Load the first component by default
              if (mixture.components[0].smiles) {
                MolecularViewer.loadMoleculeFromSmiles('mixture-component-viewer', mixture.components[0].smiles, {
                  style: 'stick',
                  colorScheme: 'cyanCarbon',
                  showLabels: false,
                  showHydrogens: true
                });
                
                // Update dropdown button text
                document.getElementById('componentSelector').textContent =
                  mixture.components[0].name || `Component 1`;
              }
            }
          })
          .catch(error => {
            console.error('Error loading mixture components for 3D view:', error);
            document.getElementById('mixture-component-viewer').innerHTML =
              `<div class="alert alert-danger">Error loading 3D model: ${error.message}</div>`;
          });
      }
    });
    
    // Set up mixture component viewer controls
    function setupMixtureComponentViewerControls(viewerId) {
      // Get the viewer instance
      const viewer = $3Dmol.viewers[viewerId];
      if (!viewer) return;
      
      // Style buttons
      document.getElementById('mixture-style-stick').addEventListener('click', function() {
        viewer.setStyle({}, {stick: {radius: 0.15, colorscheme: 'cyanCarbon'}});
        viewer.render();
        updateMixtureActiveButton(this, 'mixture-style');
      });
      
      document.getElementById('mixture-style-sphere').addEventListener('click', function() {
        viewer.setStyle({}, {sphere: {scale: 0.25, colorscheme: 'cyanCarbon'}});
        viewer.render();
        updateMixtureActiveButton(this, 'mixture-style');
      });
      
      document.getElementById('mixture-style-line').addEventListener('click', function() {
        viewer.setStyle({}, {line: {colorscheme: 'cyanCarbon'}});
        viewer.render();
        updateMixtureActiveButton(this, 'mixture-style');
      });
      
      // Surface toggle
      const surfaceBtn = document.getElementById('mixture-toggle-surface');
      surfaceBtn.dataset.state = 'off';
      surfaceBtn.addEventListener('click', function() {
        if (this.dataset.state === 'off') {
          viewer.addSurface($3Dmol.SurfaceType.VDW, {
            opacity: 0.7,
            color: 'white'
          });
          this.dataset.state = 'on';
          this.classList.add('active');
        } else {
          viewer.removeAllSurfaces();
          this.dataset.state = 'off';
          this.classList.remove('active');
        }
        viewer.render();
      });
      
      // Spin toggle
      const spinBtn = document.getElementById('mixture-toggle-spin');
      spinBtn.dataset.state = 'off';
      spinBtn.addEventListener('click', function() {
        if (this.dataset.state === 'off') {
          viewer.spin(true);
          this.dataset.state = 'on';
          this.classList.add('active');
        } else {
          viewer.spin(false);
          this.dataset.state = 'off';
          this.classList.remove('active');
        }
      });
      
      // Reset view
      document.getElementById('mixture-reset-view').addEventListener('click', function() {
        viewer.zoomTo();
        viewer.render();
      });
      
      // Set stick as default active style
      updateMixtureActiveButton(document.getElementById('mixture-style-stick'), 'mixture-style');
    }
    
    // Update active button in a button group for mixture viewer
    function updateMixtureActiveButton(activeButton, groupPrefix) {
      const buttons = document.querySelectorAll(`[id^="${groupPrefix}-"]`);
      buttons.forEach(button => {
        button.classList.remove('active');
      });
      activeButton.classList.add('active');
    }
    
    // Set up mixture analysis event handlers
    function setupMixtureAnalysis() {
      const mixtureId = window.location.pathname.split('/').pop();
      
      // Analyze Mixture button
      document.getElementById('analyze-mixture-btn').addEventListener('click', async function() {
        try {
          const loadingEl = document.getElementById('analysis-loading');
          const resultsEl = document.getElementById('analysis-results');
          
          loadingEl.classList.remove('d-none');
          resultsEl.innerHTML = '';
          
          const analysisData = await MixtureAnalysis.analyzeMixture(mixtureId);
          
          loadingEl.classList.add('d-none');
          MixtureAnalysis.renderAnalysis(analysisData, 'analysis-results');
        } catch (error) {
          console.error('Error analyzing mixture:', error);
          document.getElementById('analysis-loading').classList.add('d-none');
          document.getElementById('analysis-results').innerHTML = `
            <div class="alert alert-danger">
              Error analyzing mixture: ${error.message}
            </div>
          `;
        }
      });
      
      // Compatibility Analysis button
      document.getElementById('analyze-compatibility-btn').addEventListener('click', async function() {
        try {
          document.getElementById('compatibility-container').innerHTML = `
            <div class="text-center py-3" aria-live="polite">
              <div class="spinner-border" role="status">
                <span class="visually-hidden">Loading...</span>
              </div>
              <p class="mt-2">Analyzing compatibility...</p>
            </div>
          `;
          
          const compatibilityData = await MixtureAnalysis.analyzeCompatibility(mixtureId);
          MixtureAnalysis.renderCompatibilityMatrix(compatibilityData, 'compatibility-container');
        } catch (error) {
          console.error('Error analyzing compatibility:', error);
          document.getElementById('compatibility-container').innerHTML = `
            <div class="alert alert-danger">
              Error analyzing compatibility: ${error.message}
            </div>
          `;
        }
      });
      
      // Synergy Analysis button
      document.getElementById('analyze-synergy-btn').addEventListener('click', async function() {
        try {
          document.getElementById('synergy-container').innerHTML = `
            <div class="text-center py-3" aria-live="polite">
              <div class="spinner-border" role="status">
                <span class="visually-hidden">Loading...</span>
              </div>
              <p class="mt-2">Analyzing synergy...</p>
            </div>
          `;
          
          const synergyData = await MixtureAnalysis.analyzeSynergy(mixtureId);
          MixtureAnalysis.renderSynergyAnalysis(synergyData, 'synergy-container');
        } catch (error) {
          console.error('Error analyzing synergy:', error);
          document.getElementById('synergy-container').innerHTML = `
            <div class="alert alert-danger">
              Error analyzing synergy: ${error.message}
            </div>
          `;
        }
      });
      
      // Optimize Composition button
      document.getElementById('optimize-composition-btn').addEventListener('click', async function() {
        try {
          document.getElementById('optimization-container').innerHTML = `
            <div class="text-center py-3" aria-live="polite">
              <div class="spinner-border" role="status">
                <span class="visually-hidden">Loading...</span>
              </div>
              <p class="mt-2">Optimizing composition...</p>
            </div>
          `;
          
          const optimizationData = await MixtureAnalysis.optimizeComposition(mixtureId);
          
          // Create optimization results display
          let html = `
            <div class="alert alert-${optimizationData.optimized ? 'success' : 'warning'}">
              ${optimizationData.message}
            </div>
          `;
          
          if (optimizationData.optimized) {
            html += `
              <div class="row">
                <div class="col-md-6">
                  <h5>Original Composition</h5>
                  <ul class="list-group">
            `;
            
            optimizationData.original_composition.forEach(comp => {
              const molecule = comp.molecule_name || 'Unknown';
              html += `
                <li class="list-group-item d-flex justify-content-between align-items-center">
                  ${molecule}
                  <span class="badge bg-primary rounded-pill">${comp.concentration.toFixed(2)}%</span>
                </li>
              `;
            });
            
            html += `
                  </ul>
                </div>
                <div class="col-md-6">
                  <h5>Optimized Composition</h5>
                  <ul class="list-group">
            `;
            
            optimizationData.optimized_composition.forEach(comp => {
              const molecule = comp.molecule_name || 'Unknown';
              html += `
                <li class="list-group-item d-flex justify-content-between align-items-center">
                  ${molecule}
                  <span class="badge bg-success rounded-pill">${comp.concentration.toFixed(2)}%</span>
                </li>
              `;
            });
            
            html += `
                  </ul>
                </div>
              </div>
              
              <div class="mt-4">
                <h5>Improvement</h5>
                <p>Improvement: ${optimizationData.improvement.toFixed(2)} points (${optimizationData.improvement_percent.toFixed(2)}%)</p>
                
                <div class="d-grid gap-2 mt-3">
                  <button class="btn btn-success" id="apply-optimization-btn">
                    Apply Optimized Composition
                  </button>
                </div>
              </div>
            `;
          }
          
          document.getElementById('optimization-container').innerHTML = html;
          
          // Add event listener for the Apply button
          if (optimizationData.optimized) {
            document.getElementById('apply-optimization-btn').addEventListener('click', function() {
              // Here you would implement the logic to apply the optimized composition
              alert('This feature is not yet implemented. The optimized composition would be applied to the mixture.');
            });
          }
        } catch (error) {
          console.error('Error optimizing composition:', error);
          document.getElementById('optimization-container').innerHTML = `
            <div class="alert alert-danger">
              Error optimizing composition: ${error.message}
            </div>
          `;
        }
      });
      
      // Component Recommendations button
      document.getElementById('recommend-components-btn').addEventListener('click', async function() {
        try {
          document.getElementById('recommendations-container').innerHTML = `
            <div class="text-center py-3" aria-live="polite">
              <div class="spinner-border" role="status">
                <span class="visually-hidden">Loading...</span>
              </div>
              <p class="mt-2">Getting recommendations...</p>
            </div>
          `;
          
          const recommendationsData = await MixtureAnalysis.recommendComponents(mixtureId);
          
          // Create recommendations display
          let html = `
            <h5>Recommended Components for ${recommendationsData.mixture_name}</h5>
            <p>Target Property: ${recommendationsData.target_property} (Current Value: ${recommendationsData.current_value.toFixed(2)})</p>
            
            <div class="table-responsive">
              <table class="table table-striped">
                <thead>
                  <tr>
                    <th>Molecule</th>
                    <th>Recommended Concentration</th>
                    <th>Predicted Improvement</th>
                    <th>Compatibility</th>
                    <th>Action</th>
                  </tr>
                </thead>
                <tbody>
          `;
          
          recommendationsData.recommendations.forEach(rec => {
            html += `
              <tr>
                <td>${rec.name}</td>
                <td>${rec.recommended_concentration.toFixed(2)}%</td>
                <td>${rec.improvement.toFixed(2)} points</td>
                <td>${(rec.compatibility * 100).toFixed(0)}%</td>
                <td>
                  <button class="btn btn-sm btn-primary add-component-btn"
                          data-molecule-id="${rec.molecule_id}"
                          data-concentration="${rec.recommended_concentration}"
                          aria-label="Add ${rec.name} at ${rec.recommended_concentration}% concentration">
                    Add
                  </button>
                </td>
              </tr>
            `;
          });
          
          html += `
                </tbody>
              </table>
            </div>
          `;
          
          document.getElementById('recommendations-container').innerHTML = html;
          
          // Add event listeners for the Add buttons
          document.querySelectorAll('.add-component-btn').forEach(button => {
            button.addEventListener('click', function() {
              const moleculeId = this.getAttribute('data-molecule-id');
              const concentration = this.getAttribute('data-concentration');
              
              // Here you would implement the logic to add the component to the mixture
              alert(`This feature is not yet implemented. Component ${moleculeId} would be added at ${concentration}% concentration.`);
            });
          });
        } catch (error) {
          console.error('Error getting recommendations:', error);
          document.getElementById('recommendations-container').innerHTML = `
            <div class="alert alert-danger">
              Error getting recommendations: ${error.message}
            </div>
          `;
        }
      });
    }
    
    // Set up export and sharing functionality
    function setupExportAndSharing() {
      const mixtureId = window.location.pathname.split('/').pop();
      
      // Update data-id attributes with the mixture ID
      document.querySelector('.export-data-btn').dataset.id = mixtureId;
      document.querySelector('.share-result-btn').dataset.id = mixtureId;
      
      // Show/hide email options based on share type
      document.getElementById('share-type').addEventListener('change', function() {
        const emailOptions = document.querySelector('.share-email-options');
        emailOptions.style.display = this.value === 'email' ? 'block' : 'none';
      });
      
      // Show/hide password field based on password protection checkbox
      document.getElementById('password-protected').addEventListener('change', function() {
        const passwordField = document.querySelector('.password-field');
        passwordField.style.display = this.checked ? 'block' : 'none';
      });
      
      // Export button click handler
      document.querySelector('.export-data-btn').addEventListener('click', function() {
        const format = document.getElementById('export-format').value;
        const includeRelated = document.getElementById('include-related').checked;
        const dataType = this.dataset.type;
        const itemId = this.dataset.id;
        
        // Call the export function from export-sharing.js
        ExportManager.exportData(dataType, itemId, format, includeRelated);
      });
      
      // Share button click handler
      document.querySelector('.share-result-btn').addEventListener('click', function() {
        const shareType = document.getElementById('share-type').value;
        const dataType = this.dataset.type;
        const itemId = this.dataset.id;
        
        const options = {
          passwordProtected: document.getElementById('password-protected').checked,
          password: document.getElementById('share-password').value,
          expiration: parseInt(document.getElementById('share-expiration').value, 10)
        };
        
        // Add recipients and message for email sharing
        if (shareType === 'email') {
          options.recipients = document.getElementById('share-recipients').value.split(',').map(email => email.trim()).filter(email => email);
          options.message = document.getElementById('share-message').value;
        }
        
        // Call the share function from export-sharing.js
        ShareManager.shareItem(dataType, itemId, shareType, options);
      });
    }
  </script>
</body>
</html>