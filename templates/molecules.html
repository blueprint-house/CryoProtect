{% extends 'base.html' %}

{% set active_page = 'molecules' %}
{% set breadcrumbs = [
  {'title': 'Home', 'url': '/'},
  {'title': 'Molecules', 'url': '/molecules'}
] %}

{% block title %}Molecules - CryoProtect Analyzer{% endblock %}

{% block content %}
    <!-- Molecules List View -->
    <div id="molecules-list-view">
      <div class="d-flex justify-content-between align-items-center mb-4">
        <h1>Molecules</h1>
        <div class="d-flex">
          <a href="/molecules/integrated" class="btn btn-success me-2">
            <i class="bi bi-eye"></i> Integrated Viewer
          </a>
          <a href="/molecules/rdkit" class="btn btn-info me-2">
            <i class="bi bi-diagram-2"></i> RDKit Viewer
          </a>
          {% if current_user and current_user.is_authenticated %}
          <a href="/molecules/import" class="btn btn-primary">
            <i class="bi bi-plus-circle"></i> Import Molecule
          </a>
          {% else %}
          <span class="btn btn-primary disabled" title="Login required to import molecules">
            <i class="bi bi-plus-circle"></i> Import Molecule
          </span>
          <span class="ms-2 text-danger align-self-center">Login to import molecules</span>
          {% endif %}
        </div>
      </div>
      
      <!-- Search and Filter -->
      <div class="card mb-4">
        <div class="card-body">
          <div class="row">
            <div class="col-12 col-md-8 mb-3 mb-md-0">
              <div class="input-group">
                <input type="text" class="form-control" id="molecule-search" placeholder="Search molecules...">
                <button class="btn btn-outline-secondary" type="button" id="search-button">
                  <i class="bi bi-search"></i>
                </button>
              </div>
            </div>
            <div class="col-12 col-md-4">
              <select class="form-select" id="molecule-filter">
                <option value="all">All Molecules</option>
                <option value="high-score">High Score (>70)</option>
                <option value="medium-score">Medium Score (40-70)</option>
                <option value="low-score">Low Score (<40)</option>
              </select>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Molecules Grid -->
      <div class="row" id="molecules-container">
        <!-- Molecules will be loaded here dynamically -->
        <div class="col-12 text-center py-5">
          <div class="spinner-border" role="status">
            <span class="visually-hidden">Loading...</span>
          </div>
          <p class="mt-2">Loading molecules...</p>
        </div>
      </div>
    </div>
    
    <!-- Molecule Detail View -->
    <div id="molecule-detail-view" style="display: none;">
      <!-- Dynamic breadcrumbs for molecule detail -->
      <div id="molecule-detail-breadcrumbs">
        <nav aria-label="breadcrumb" class="mb-4">
          <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="/">Home</a></li>
            <li class="breadcrumb-item"><a href="/molecules">Molecules</a></li>
            <li class="breadcrumb-item active" aria-current="page"><span id="breadcrumb-molecule-name">Molecule Details</span></li>
          </ol>
        </nav>
      </div>
      
      <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 id="molecule-name">Molecule Name</h1>
        <a href="/molecules" class="btn btn-outline-secondary">
          <i class="bi bi-arrow-left"></i> Back to Molecules
        </a>
      </div>
      
      <div class="row">
        <div class="col-12 col-lg-6 mb-4">
          <div class="card mb-4">
            <div class="card-header">
              Basic Information
            </div>
            <div class="card-body">
              <p><strong>Formula:</strong> <span id="molecule-formula">-</span></p>
              <p><strong>SMILES:</strong> <span id="molecule-smiles">-</span></p>
              <p>
                <a href="#" id="pubchem-link" target="_blank" class="btn btn-sm btn-outline-primary me-2">
                  <i class="bi bi-box-arrow-up-right"></i> View on PubChem
                </a>
                <a href="#" id="integrated-viewer-link" class="btn btn-sm btn-success">
                  <i class="bi bi-eye"></i> View in Integrated Viewer
                </a>
              </p>
            </div>
          </div>
          
          <div class="card mb-4">
            <div class="card-header d-flex justify-content-between align-items-center">
              <h5 class="card-title mb-0">3D Molecular Viewer</h5>
              <div class="btn-toolbar" id="molecule-viewer-toolbar" role="toolbar" aria-label="Molecular viewer controls">
                <!-- Toolbar will be populated by JavaScript -->
              </div>
            </div>
            <div class="card-body">
              <div id="molecule-viewer-container" class="molecular-viewer" style="height: 300px; width: 100%; position: relative;">
                <div class="text-center py-5">
                  <p class="text-muted">Select a molecule to view 3D structure</p>
                </div>
              </div>
              <div class="mt-3">
                <div class="d-flex justify-content-center" role="group" aria-label="Visualization style">
                  <button type="button" class="btn btn-outline-primary btn-sm me-1" id="style-stick">
                    <i class="bi bi-diagram-3"></i> Stick
                  </button>
                  <button type="button" class="btn btn-outline-primary btn-sm me-1" id="style-sphere">
                    <i class="bi bi-circle"></i> Sphere
                  </button>
                  <button type="button" class="btn btn-outline-primary btn-sm me-1" id="style-line">
                    <i class="bi bi-slash-lg"></i> Line
                  </button>
                  <button type="button" class="btn btn-outline-secondary btn-sm me-1" id="toggle-surface">
                    <i class="bi bi-egg"></i> Surface
                  </button>
                  <button type="button" class="btn btn-outline-secondary btn-sm me-1" id="toggle-spin">
                    <i class="bi bi-arrow-repeat"></i> Spin
                  </button>
                  <button type="button" class="btn btn-outline-secondary btn-sm" id="reset-view">
                    <i class="bi bi-arrow-counterclockwise"></i> Reset
                  </button>
                </div>
              </div>
            </div>
          </div>
          
          <div class="card">
            <div class="card-header">
              Properties
            </div>
            <div class="card-body">
              <div class="table-responsive">
                <table class="table table-hover">
                  <thead>
                    <tr>
                      <th>Property</th>
                      <th>Value</th>
                    </tr>
                  </thead>
                  <tbody id="molecule-properties">
                    <!-- Properties will be loaded here dynamically -->
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
        
        <div class="col-12 col-lg-6">
          <div class="card mb-4">
            <div class="card-header">
              Property Profile
            </div>
            <div class="card-body">
              <div class="chart-container">
                <canvas id="molecule-radar-chart"></canvas>
              </div>
            </div>
          </div>
          
          <div class="card">
            <div class="card-header">
              Actions
            </div>
            <div class="card-body">
              <div class="d-grid gap-2">
                {% if current_user and current_user.is_authenticated %}
                <a href="#" class="btn btn-primary" id="add-to-mixture-btn">
                  <i class="bi bi-droplet"></i> Add to Mixture
                </a>
                <a href="#" class="btn btn-outline-primary" id="predict-properties-btn">
                  <i class="bi bi-graph-up"></i> Predict Properties
                </a>
                {% else %}
                <span class="btn btn-primary disabled" title="Login required to add to mixture">
                  <i class="bi bi-droplet"></i> Add to Mixture
                </span>
                <span class="btn btn-outline-primary disabled mt-2" title="Login required to predict properties">
                  <i class="bi bi-graph-up"></i> Predict Properties
                </span>
                <div class="mt-2 text-danger">Login to access these actions</div>
                {% endif %}
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Import Molecule View -->
    <div id="import-molecule-view" style="display: none;">
      <!-- Breadcrumbs for import molecule -->
      <nav aria-label="breadcrumb" class="mb-4">
        <ol class="breadcrumb">
          <li class="breadcrumb-item"><a href="/">Home</a></li>
          <li class="breadcrumb-item"><a href="/molecules">Molecules</a></li>
          <li class="breadcrumb-item active" aria-current="page">Import Molecule</li>
        </ol>
      </nav>
      
      <div class="d-flex justify-content-between align-items-center mb-4">
        <h1>Import Molecule from PubChem</h1>
        <a href="/molecules" class="btn btn-outline-secondary">
          <i class="bi bi-arrow-left"></i> Back to Molecules
        </a>
      </div>
      
      <div class="row">
        <div class="col-12 col-md-6 mb-4 mb-md-0">
          <div class="card h-100">
            <div class="card-header">
              Import by CID
            </div>
            <div class="card-body">
              <form id="molecule-import-form">
                <div class="mb-3">
                  <label for="pubchem-cid" class="form-label">PubChem Compound ID (CID)</label>
                  <input type="number" class="form-control" id="pubchem-cid" required min="1">
                  <div class="form-text">Enter the CID of the molecule you want to import from PubChem.</div>
                </div>
                <button type="submit" class="btn btn-primary">Import Molecule</button>
              </form>
            </div>
          </div>
        </div>
        
        <div class="col-12 col-md-6">
          <div class="card h-100">
            <div class="card-header">
              How to Find a CID
            </div>
            <div class="card-body">
              <p>To find a PubChem Compound ID (CID):</p>
              <ol>
                <li>Visit <a href="https://pubchem.ncbi.nlm.nih.gov/" target="_blank">PubChem</a></li>
                <li>Search for a molecule by name or formula</li>
                <li>Open the compound page</li>
                <li>Look for the CID in the URL or on the page</li>
              </ol>
              <p>Example CIDs for cryoprotectants:</p>
              <ul>
                <li>Glycerol: 753</li>
                <li>Dimethyl sulfoxide (DMSO): 679</li>
                <li>Ethylene glycol: 174</li>
                <li>Propylene glycol: 1030</li>
                <li>Trehalose: 7427</li>
              </ul>
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Import Molecule Modal -->
    <div class="modal fade" id="import-molecule-modal" tabindex="-1" aria-labelledby="import-molecule-modal-label" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="import-molecule-modal-label">Import Molecule from PubChem</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <form id="import-molecule-form" onsubmit="importMolecule(event)">
              <div class="mb-3">
                <label for="pubchem-cid" class="form-label">PubChem Compound ID (CID)</label>
                <input type="number" class="form-control" id="pubchem-cid" required min="1">
                <div class="form-text">Enter the CID of the molecule you want to import from PubChem.</div>
              </div>
              <div class="mb-3">
                <p>Example CIDs for cryoprotectants:</p>
                <ul>
                  <li>Glycerol: 753</li>
                  <li>Dimethyl sulfoxide (DMSO): 679</li>
                  <li>Ethylene glycol: 174</li>
                  <li>Propylene glycol: 1030</li>
                  <li>Trehalose: 7427</li>
                </ul>
              </div>
              <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="submit" class="btn btn-primary">Import Molecule</button>
              </div>
            </form>
          </div>
        </div>
      </div>
    </div>
{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="https://3Dmol.org/build/3Dmol-min.css">
<style>
  .molecular-viewer {
    border: 1px solid #dee2e6;
    border-radius: 0.25rem;
    overflow: hidden;
  }
  
  .molecular-viewer canvas {
    outline: none;
  }
  
  /* Accessibility improvements */
  .sr-only {
    position: absolute;
    width: 1px;
    height: 1px;
    padding: 0;
    margin: -1px;
    overflow: hidden;
    clip: rect(0, 0, 0, 0);
    white-space: nowrap;
    border-width: 0;
  }
  
  /* Focus indicators for keyboard navigation */
  .btn:focus {
    box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.5);
    z-index: 1;
  }
</style>
{% endblock %}

{% block extra_js %}
<script src="https://3Dmol.org/build/3Dmol-min.js"></script>
<script src="{{ url_for('static', filename='js/molecular-viewer.js') }}"></script>
<script src="{{ url_for('static', filename='js/pagination_component.js') }}"></script>
<script src="{{ url_for('static', filename='js/compound_list.js') }}"></script>
<script>
    // Initialize page based on URL
    document.addEventListener('DOMContentLoaded', function() {
      const path = window.location.pathname;
      
      // Show the appropriate view based on the URL
      if (path.endsWith('/import')) {
        document.getElementById('molecules-list-view').style.display = 'none';
        document.getElementById('molecule-detail-view').style.display = 'none';
        document.getElementById('import-molecule-view').style.display = 'block';
      } else if (path.match(/\/molecules\/[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i)) {
        document.getElementById('molecules-list-view').style.display = 'none';
        document.getElementById('molecule-detail-view').style.display = 'block';
        document.getElementById('import-molecule-view').style.display = 'none';
        
        // Update breadcrumb with molecule name when it's loaded
        const updateBreadcrumb = function() {
          const moleculeName = document.getElementById('molecule-name').textContent;
          if (moleculeName && moleculeName !== 'Molecule Name') {
            document.getElementById('breadcrumb-molecule-name').textContent = moleculeName;
          }
        };
        
        // Set up a MutationObserver to watch for changes to the molecule name
        const observer = new MutationObserver(updateBreadcrumb);
        observer.observe(document.getElementById('molecule-name'), { childList: true, subtree: true });
        
        // Initialize molecular viewer when molecule details are loaded
        const moleculeId = path.split('/').pop();
        
        // Fetch molecule details
        fetch(`/api/v1/molecules/${moleculeId}`)
          .then(response => response.json())
          .then(molecule => {
            if (molecule && molecule.smiles) {
              // Initialize the 3D viewer
              MolecularViewer.initViewer('molecule-viewer-container', {
                backgroundColor: 'white',
                height: 300
              });
              
              // Load the molecule from SMILES
              MolecularViewer.loadMoleculeFromSmiles('molecule-viewer-container', molecule.smiles, {
                style: 'stick',
                colorScheme: 'cyanCarbon',
                showLabels: false,
                showHydrogens: true
              });
              
              // Set up viewer controls
              setupMoleculeViewerControls('molecule-viewer-container');
            }
          })
          .catch(error => {
            console.error('Error loading molecule for 3D view:', error);
            document.getElementById('molecule-viewer-container').innerHTML =
              `<div class="alert alert-danger">Error loading 3D model: ${error.message}</div>`;
          });
      } else {
        document.getElementById('molecules-list-view').style.display = 'block';
        document.getElementById('molecule-detail-view').style.display = 'none';
        document.getElementById('import-molecule-view').style.display = 'none';
      }
    });
    
    // Set up molecule viewer controls
    function setupMoleculeViewerControls(viewerId) {
      // Get the viewer instance
      const viewer = $3Dmol.viewers[viewerId];
      if (!viewer) return;
      
      // Style buttons
      document.getElementById('style-stick').addEventListener('click', function() {
        viewer.setStyle({}, {stick: {radius: 0.15, colorscheme: 'cyanCarbon'}});
        viewer.render();
        updateActiveButton(this, 'style');
      });
      
      document.getElementById('style-sphere').addEventListener('click', function() {
        viewer.setStyle({}, {sphere: {scale: 0.25, colorscheme: 'cyanCarbon'}});
        viewer.render();
        updateActiveButton(this, 'style');
      });
      
      document.getElementById('style-line').addEventListener('click', function() {
        viewer.setStyle({}, {line: {colorscheme: 'cyanCarbon'}});
        viewer.render();
        updateActiveButton(this, 'style');
      });
      
      // Surface toggle
      const surfaceBtn = document.getElementById('toggle-surface');
      surfaceBtn.dataset.state = 'off';
      surfaceBtn.addEventListener('click', function() {
        if (this.dataset.state === 'off') {
          viewer.addSurface($3Dmol.SurfaceType.VDW, {
            opacity: 0.7,
            color: 'white'
          });
          this.dataset.state = 'on';
          this.classList.add('active');
        } else {
          viewer.removeAllSurfaces();
          this.dataset.state = 'off';
          this.classList.remove('active');
        }
        viewer.render();
      });
      
      // Spin toggle
      const spinBtn = document.getElementById('toggle-spin');
      spinBtn.dataset.state = 'off';
      spinBtn.addEventListener('click', function() {
        if (this.dataset.state === 'off') {
          viewer.spin(true);
          this.dataset.state = 'on';
          this.classList.add('active');
        } else {
          viewer.spin(false);
          this.dataset.state = 'off';
          this.classList.remove('active');
        }
      });
      
      // Reset view
      document.getElementById('reset-view').addEventListener('click', function() {
        viewer.zoomTo();
        viewer.render();
      });
      
      // Set stick as default active style
      updateActiveButton(document.getElementById('style-stick'), 'style');
    }
    
    // Update active button in a button group
    function updateActiveButton(activeButton, groupPrefix) {
      const buttons = document.querySelectorAll(`[id^="${groupPrefix}-"]`);
      buttons.forEach(button => {
        button.classList.remove('active');
      });
      activeButton.classList.add('active');
    }
</script>
{% endblock %}