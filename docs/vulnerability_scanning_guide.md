# Vulnerability Scanning Guide

This document provides information on the automated vulnerability scanning tools integrated into the CryoProtect v2 project, how to use them, and how to remediate identified vulnerabilities.

## Overview

The following vulnerability scanning tools have been integrated:

1. **Bandit** - Static code analysis for Python
2. **Safety** - Dependency vulnerability scanning for Python
3. **ESLint Security Plugins** - Static code analysis for JavaScript
4. **OWASP Dependency-Check** - Dependency vulnerability scanning for multiple languages
5. **Trivy** - Container image vulnerability scanning

These tools are configured to run in the following contexts:

- **CI/CD Pipeline** - Automatically run on every pull request and push to main branches
- **Scheduled Scans** - Daily and weekly scans for continuous monitoring
- **On-Demand Scans** - Can be run manually when needed

## CI/CD Integration

The vulnerability scanning tools are integrated into both GitHub Actions and GitLab CI pipelines. The pipelines are configured to fail when critical vulnerabilities are detected, ensuring that security issues are addressed before code is merged or deployed.

### GitHub Actions

The GitHub Actions workflow (`.github/workflows/ci-cd.yml`) includes the following security scanning steps:

1. Python vulnerability scanning with Bandit and Safety
2. JavaScript vulnerability scanning with ESLint security plugins
3. Dependency vulnerability scanning with OWASP Dependency-Check
4. Container image scanning with Trivy

### GitLab CI

The GitLab CI pipeline (`.gitlab-ci.yml`) includes similar security scanning steps:

1. Python vulnerability scanning with Bandit and Safety
2. JavaScript vulnerability scanning with ESLint security plugins
3. Container image scanning with Trivy
4. SBOM generation for tracking dependencies

## Running Scans Manually

You can run vulnerability scans manually using the provided scripts in the `security/` directory.

### Python Code Scanning with Bandit

```bash
python security/scan_python_bandit.py --path . --format json --output bandit-results.json
```

Options:
- `--path PATH` - Path to scan (default: current directory)
- `--format FORMAT` - Output format (json, yaml, csv, txt) (default: txt)
- `--output FILE` - Output file (default: bandit-results.{format})
- `--severity SEVERITY` - Minimum severity to report (low, medium, high) (default: low)
- `--confidence CONF` - Minimum confidence to report (low, medium, high) (default: low)
- `--exit-on-critical` - Exit with code 1 if critical issues found
- `--exclude PATTERN` - Comma-separated list of paths to exclude

### Python Dependency Scanning with Safety

```bash
python security/scan_python_safety.py --requirements requirements.txt --format json --output safety-results.json
```

Options:
- `--requirements FILE` - Requirements file to scan (default: requirements.txt)
- `--format FORMAT` - Output format (json, text, bare, full) (default: text)
- `--output FILE` - Output file (default: safety-results.{format})
- `--exit-on-critical` - Exit with code 1 if critical vulnerabilities found
- `--api-key KEY` - Safety API key for full database access

### JavaScript Scanning with ESLint Security Plugins

```bash
node security/scan_js_eslint.js --path ./static/js --format json --output eslint-results.json
```

Options:
- `--path PATH` - Path to scan (default: ./static/js)
- `--format FORMAT` - Output format (json, stylish, html) (default: stylish)
- `--output FILE` - Output file (default: eslint-results.{format})
- `--exit-on-critical` - Exit with code 1 if critical issues found
- `--config FILE` - Custom ESLint config file

### Dependency Scanning with OWASP Dependency-Check

```bash
bash security/scan_dependency_check.sh --path . --format HTML,JSON --output ./dependency-check-reports
```

Options:
- `--path PATH` - Path to scan (default: current directory)
- `--format FORMAT` - Output format (HTML, XML, CSV, JSON, JUNIT, SARIF) (default: HTML)
- `--output DIR` - Output directory (default: ./dependency-check-reports)
- `--name NAME` - Project name (default: CryoProtect)
- `--exit-on-critical` - Exit with code 1 if critical vulnerabilities found (CVSS >= 7.0)
- `--nvd-api-key KEY` - NVD API key for better performance

### Docker Image Scanning with Trivy

```bash
bash scripts/scan_docker_image.sh --format json --output trivy-results.json cryoprotect:latest
```

Options:
- `--format FORMAT` - Output format (table, json, sarif, cyclonedx) (default: table)
- `--output FILE` - Output file name (default: trivy-results.{format})
- `--severity SEVERITY` - Severities to scan for (comma-separated) (default: CRITICAL,HIGH,MEDIUM)
- `--exit-code CODE` - Exit code when vulnerabilities are found (default: 0)
- `--fail-on SEVERITY` - Fail on specific severity (CRITICAL, HIGH, MEDIUM, LOW, UNKNOWN) (default: CRITICAL)

## Scheduled Scans

Scheduled vulnerability scans can be set up using the provided script:

```bash
bash security/schedule_vulnerability_scans.sh --install --daily --weekly --alert-email security@example.com
```

Options:
- `--install` - Install and configure scheduled scans
- `--run` - Run all vulnerability scans now
- `--daily` - Run daily scans
- `--weekly` - Run weekly scans
- `--alert-email EMAIL` - Email address for alerts
- `--alert-slack URL` - Slack webhook URL for alerts

This will set up:
- Daily scans (at 2:00 AM) for quick-running tools (Bandit, Safety, ESLint)
- Weekly scans (on Sunday at 3:00 AM) for all tools including more intensive ones (OWASP Dependency-Check)

## Reviewing and Remediating Vulnerabilities

The `security/review_vulnerability_results.py` script helps you review and track the remediation of vulnerabilities:

```bash
python security/review_vulnerability_results.py --scan-dir ./security/reports --output ./security/remediation_report.md
```

Options:
- `--scan-dir DIR` - Directory containing scan results (default: ./security/reports)
- `--output FILE` - Output report file (default: ./security/remediation_report.md)
- `--format FORMAT` - Output format (markdown, html, json) (default: markdown)
- `--threshold CVSS` - CVSS threshold for critical vulnerabilities (default: 7.0)
- `--update` - Update existing remediation status

### Remediation Workflow

1. Run the vulnerability scans
2. Generate a remediation report
3. Review the report and update the status of each vulnerability
4. Run the review script with `--update` to track progress
5. Fix the identified vulnerabilities
6. Run the scans again to verify the fixes

### Common Remediation Actions

#### Python Code Issues (Bandit)

1. **Insecure Use of `eval()`**: Replace with safer alternatives like `ast.literal_eval()` or explicit parsing
2. **Hardcoded Passwords/Secrets**: Move to environment variables or secure secret management
3. **SQL Injection**: Use parameterized queries or ORM
4. **Command Injection**: Avoid using `os.system()` or `subprocess` with shell=True
5. **Insecure Deserialization**: Avoid `pickle` for untrusted data, use JSON or other safe formats

#### Python Dependencies (Safety)

1. Update the vulnerable package to a non-vulnerable version
2. If an update is not available, consider alternative packages
3. If the vulnerability is not applicable to your usage, document why it's a false positive

#### JavaScript Issues (ESLint)

1. **DOM XSS**: Use safe DOM APIs and sanitize user input
2. **Insecure Random**: Use `crypto.getRandomValues()` instead of `Math.random()`
3. **Eval Usage**: Avoid `eval()`, `new Function()`, and other dynamic code execution
4. **Prototype Pollution**: Validate and sanitize object inputs

#### Dependencies (OWASP Dependency-Check)

1. Update the vulnerable dependency to a non-vulnerable version
2. If an update is not available, consider alternative dependencies
3. If the vulnerability is in a transitive dependency, update the direct dependency

## Best Practices

1. **Run Scans Regularly**: Set up scheduled scans to catch vulnerabilities early
2. **Fix Critical Vulnerabilities Immediately**: Critical vulnerabilities should be fixed as soon as possible
3. **Track Remediation Progress**: Use the remediation report to track progress
4. **Document False Positives**: If a vulnerability is a false positive, document why
5. **Update Dependencies Regularly**: Regularly update dependencies to reduce vulnerability exposure
6. **Educate Developers**: Share knowledge about common vulnerabilities and how to avoid them

## Additional Resources

- [Bandit Documentation](https://bandit.readthedocs.io/)
- [Safety Documentation](https://pyup.io/safety/)
- [ESLint Security Plugin](https://github.com/nodesecurity/eslint-plugin-security)
- [OWASP Dependency-Check](https://owasp.org/www-project-dependency-check/)
- [Trivy Documentation](https://aquasecurity.github.io/trivy/)
- [OWASP Top 10](https://owasp.org/www-project-top-ten/)
- [CVSS Scoring System](https://www.first.org/cvss/)